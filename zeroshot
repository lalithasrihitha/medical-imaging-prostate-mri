import os
import SimpleITK as sitk
import numpy as np
import cv2
import matplotlib.pyplot as plt

#  Output directory
output_dir = "results_canny_contour"
os.makedirs(output_dir, exist_ok=True)

#detecting folders
patient_ids = [
    folder for folder in os.listdir()
    if os.path.isdir(folder)
]

# Processing each patient
for pid in patient_ids:
    print(f"\nProcessing patient {pid} with Canny contour...")

    # File paths (inside each patient folder)
    t2w_file = os.path.join(pid, f"{pid}_t2w.nii.gz")
    gland_file = os.path.join(pid, f"{pid}_gland.nii.gz")

    if not (os.path.exists(t2w_file) and os.path.exists(gland_file)):
        print(f"Skipping {pid}, required files not found")
        continue

    # Load MRI and gland mask
    t2w_img = sitk.GetArrayFromImage(sitk.ReadImage(t2w_file))
    gland_img = sitk.GetArrayFromImage(sitk.ReadImage(gland_file))

    # Middle slice
    mid_slice = t2w_img.shape[0] // 2
    t2w_slice = t2w_img[mid_slice, :, :]
    mask_slice = gland_img[mid_slice, :, :]

    # Normalize T2W for display
    t2w_norm = cv2.normalize(t2w_slice, None, 0, 255, cv2.NORM_MINMAX).astype(np.uint8)

    # Applying mask to keep only prostate region
    masked = cv2.bitwise_and(
        t2w_norm,
        t2w_norm,
        mask=(mask_slice > 0).astype(np.uint8)
    )

    # Blur before Canny to reduce noise
    blurred = cv2.GaussianBlur(masked, (5, 5), 1.4)

    # Canny edge detection
    edges = cv2.Canny(blurred, threshold1=50, threshold2=150)

    # Find contours from Canny edges
    contours, _ = cv2.findContours(
        edges,
        cv2.RETR_EXTERNAL,
        cv2.CHAIN_APPROX_SIMPLE
    )

    # Orientation fix (if needed)
    if t2w_slice.shape[1] < t2w_slice.shape[0]:
        t2w_disp = t2w_norm.T
        edges_disp = edges.T
    else:
        t2w_disp = t2w_norm
        edges_disp = edges

    fig, axes = plt.subplots(1, 3, figsize=(15, 5))

    # Original T2W
    axes[0].imshow(t2w_disp, cmap="gray")
    axes[0].set_title("Original T2W")
    axes[0].axis("off")

    # Canny Edges
    axes[1].imshow(edges_disp, cmap="gray")
    axes[1].set_title("Canny Edges")
    axes[1].axis("off")

    # Contour Overlay
    axes[2].imshow(t2w_disp, cmap="gray")
    for contour in contours:
        axes[2].plot(
            contour[:, 0, 0],
            contour[:, 0, 1],
            color="red",
            linewidth=1.5
        )
    axes[2].set_title("Canny Contour Overlay")
    axes[2].axis("off")

    # Title and save
    plt.suptitle(f"Patient {pid} - Canny Contours",
                 fontsize=16,
                 fontweight="bold")
    plt.tight_layout()
    plt.subplots_adjust(top=0.85)

    out_path = os.path.join(output_dir, f"{pid}_canny_contour.png")
    fig.savefig(out_path, bbox_inches="tight", dpi=300, facecolor="white")
    plt.close(fig)

    print(f"Saved {out_path}")

print("\nAll patients processed with Canny contour detection.")
