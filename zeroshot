import os
import SimpleITK as sitk
import numpy as np
import cv2
import matplotlib.pyplot as plt

#  detecting patient folders inside current directory
patient_ids = [
    folder for folder in os.listdir()
    if os.path.isdir(folder)
]

# otput
output_dir = "output"
os.makedirs(output_dir, exist_ok=True)

for pid in patient_ids:
    print(f"\nProcessing patient {pid} with Canny contour...")

    # Automatically detect MRI and mask files inside patient folder
    files = os.listdir(pid)
    t2w_file = next((os.path.join(pid, f) for f in files if "t2w" in f.lower()), None)
    gland_file = next((os.path.join(pid, f) for f in files if "gland" in f.lower()), None)

    if not t2w_file or not gland_file:
        print(f"Skipping {pid}, required files not found")
        continue

    # Load MRI and gland mask
    t2w_img = sitk.GetArrayFromImage(sitk.ReadImage(t2w_file))
    gland_img = sitk.GetArrayFromImage(sitk.ReadImage(gland_file))

    # Middle slice
    mid_slice = t2w_img.shape[0] // 2
    t2w_slice = t2w_img[mid_slice]
    mask_slice = gland_img[mid_slice]

    # Normalize for display
    t2w_norm = cv2.normalize(t2w_slice, None, 0, 255, cv2.NORM_MINMAX).astype(np.uint8)

    # Apply mask
    masked = cv2.bitwise_and(
        t2w_norm,
        t2w_norm,
        mask=(mask_slice > 0).astype(np.uint8)
    )

    # Blur before Canny
    blurred = cv2.GaussianBlur(masked, (5, 5), 1.4)

    # Canny
    edges = cv2.Canny(blurred, 50, 150)

    # Find contours
    contours, _ = cv2.findContours(
        edges,
        cv2.RETR_EXTERNAL,
        cv2.CHAIN_APPROX_SIMPLE
    )

    # Orientation fix
    if t2w_slice.shape[1] < t2w_slice.shape[0]:
        t2w_disp = t2w_norm.T
        edges_disp = edges.T
    else:
        t2w_disp = t2w_norm
        edges_disp = edges

    fig, axes = plt.subplots(1, 3, figsize=(15, 5))

    # Original
    axes[0].imshow(t2w_disp, cmap="gray")
    axes[0].set_title("Original T2W")
    axes[0].axis("off")

    # Edges
    axes[1].imshow(edges_disp, cmap="gray")
    axes[1].set_title("Canny Edges")
    axes[1].axis("off")

    # Contour Overlay
    axes[2].imshow(t2w_disp, cmap="gray")
    for contour in contours:
        axes[2].plot(contour[:, 0, 0], contour[:, 0, 1], color="red", linewidth=1.5)
    axes[2].set_title("Canny Contour Overlay")
    axes[2].axis("off")

    plt.suptitle(f"Patient {pid}", fontsize=16, fontweight="bold")
    plt.tight_layout()
    plt.subplots_adjust(top=0.85)

    fig.savefig(os.path.join(output_dir, f"{pid}_canny.png"),
                bbox_inches="tight",
                dpi=300,
                facecolor="white")

    plt.close(fig)

    print(f"Saved output for {pid}")

print("\nAll patients processed successfully.")
